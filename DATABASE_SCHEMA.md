# PostForge Database Schema Documentation

## Overview
PostForge uses PostgreSQL (hosted on Supabase) with Prisma ORM for type-safe database access. This document outlines the complete database schema, relationships, indexes, and optimization strategies.

---

## Schema Version
- **Prisma Version**: 6.19.0
- **Database**: PostgreSQL (Supabase)
- **Last Updated**: 2025-12-03
- **Migrations**: 2 (0_init, 20251203171537_add_schema_optimizations)

---

## Models

### User Model
The core user model synchronized with Clerk authentication.

```prisma
model User {
  id             String   @id @default(cuid())
  clerkId        String   @unique
  email          String   @unique
  credits        Int      @default(10)
  organizationId String?  // Optional: for Team plan support
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  posts              Post[]
  creditTransactions CreditTransaction[]

  @@index([clerkId])
  @@index([email])
  @@index([organizationId])
}
```

**Fields:**
- `id`: Primary key (CUID format)
- `clerkId`: Unique identifier from Clerk Auth
- `email`: User email (unique)
- `credits`: Available credits for post generation (default: 10)
- `organizationId`: Organization membership (nullable for individual users)
- `createdAt`: Account creation timestamp
- `updatedAt`: Last modification timestamp

**Indexes:**
- `clerkId`: Fast lookup for authentication
- `email`: Fast lookup for user queries
- `organizationId`: Support for team-based queries

**Relationships:**
- OneToMany with Post (cascade delete)
- OneToMany with CreditTransaction (cascade delete)

---

### Post Model
Stores LinkedIn posts generated by AI.

```prisma
model Post {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  content   String   @db.VarChar(500) // MAX 500 chars validation
  platform  String   @default("linkedin")
  status    String   @default("draft") // draft, scheduled, published, failed
  metadata  Json     @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}
```

**Fields:**
- `id`: Primary key (CUID format)
- `userId`: Foreign key to User
- `content`: Post content (max 500 characters for performance)
- `platform`: Target platform (default: "linkedin")
- `status`: Post lifecycle status
  - `draft`: Initial state after generation
  - `scheduled`: Queued for publishing
  - `published`: Successfully posted
  - `failed`: Publishing failed
- `metadata`: Additional data (JSON)
  - `tone`: AI generation tone
  - `generatedAt`: Generation timestamp
  - `publishedAt`: Publishing timestamp
  - `scheduledFor`: Scheduled time
  - `errorMessage`: Error details (if failed)

**Indexes:**
- `userId`: Fast lookup for user's posts
- `status`: Fast filtering by post status
- `createdAt`: Chronological sorting

**Optimizations:**
- VARCHAR(500) limit prevents large text storage
- Status index enables efficient filtering
- Cascade delete ensures cleanup when user deleted

---

### CreditTransaction Model
Tracks credit usage, purchases, and refunds.

```prisma
model CreditTransaction {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount      Int      // MIN 1 (validated in application logic)
  type        String   // "generation", "purchase", "refund", "bonus"
  description String   @default("")

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}
```

**Fields:**
- `id`: Primary key (CUID format)
- `userId`: Foreign key to User
- `amount`: Credit amount (positive for additions, negative for deductions)
- `type`: Transaction type
  - `generation`: Credit used for post generation (-1)
  - `purchase`: Credits purchased via Stripe (+N)
  - `refund`: Credits refunded (+N)
  - `bonus`: Welcome bonus or promotions (+N)
- `description`: Human-readable transaction description
- `createdAt`: Transaction timestamp

**Indexes:**
- `userId`: Fast lookup for user's transaction history
- `type`: Fast filtering by transaction type
- `createdAt`: Chronological sorting

**Validation:**
- Minimum amount: 1 (enforced in application logic)
- No direct amount constraints in database schema

---

## Relationships Diagram

```
User
├── Posts (OneToMany, Cascade Delete)
│   └── Post.userId -> User.id
└── CreditTransactions (OneToMany, Cascade Delete)
    └── CreditTransaction.userId -> User.id
```

### Cascade Delete Behavior
When a User is deleted:
1. All associated Posts are automatically deleted
2. All associated CreditTransactions are automatically deleted
3. Ensures data integrity and prevents orphaned records

---

## Indexes Summary

### User Table
1. `User_pkey` (PRIMARY KEY on id)
2. `User_clerkId_key` (UNIQUE on clerkId)
3. `User_clerkId_idx` (INDEX on clerkId)
4. `User_email_key` (UNIQUE on email)
5. `User_email_idx` (INDEX on email)
6. `User_organizationId_idx` (INDEX on organizationId)

### Post Table
1. `Post_pkey` (PRIMARY KEY on id)
2. `Post_userId_idx` (INDEX on userId)
3. `Post_status_idx` (INDEX on status)
4. `Post_createdAt_idx` (INDEX on createdAt)

### CreditTransaction Table
1. `CreditTransaction_pkey` (PRIMARY KEY on id)
2. `CreditTransaction_userId_idx` (INDEX on userId)
3. `CreditTransaction_type_idx` (INDEX on type)
4. `CreditTransaction_createdAt_idx` (INDEX on createdAt)

**Total Indexes**: 14 (optimized for query performance)

---

## Migrations

### 0_init (Initial Schema)
- Created User, Post, CreditTransaction tables
- Added all foreign key relationships
- Added initial indexes
- Configured cascade deletes

### 20251203171537_add_schema_optimizations
**Changes:**
- Post.content: Changed from TEXT to VARCHAR(500)
- Added Post.status index for filtering
- Added CreditTransaction.type index for transaction queries

**SQL:**
```sql
-- AlterTable
ALTER TABLE "Post" ALTER COLUMN "content" SET DATA TYPE VARCHAR(500);

-- CreateIndex
CREATE INDEX "CreditTransaction_type_idx" ON "CreditTransaction"("type");

-- CreateIndex
CREATE INDEX "Post_status_idx" ON "Post"("status");
```

---

## Performance Optimizations

### Content Length Limit
- **Before**: TEXT (unlimited)
- **After**: VARCHAR(500)
- **Benefit**:
  - Faster indexing
  - Reduced storage overhead
  - Enforces business rule (LinkedIn optimal length)

### Strategic Indexes
1. **User lookups**: clerkId, email (for authentication)
2. **Post queries**: userId, status, createdAt (for dashboard)
3. **Transaction history**: userId, type, createdAt (for billing)

### Cascade Deletes
- Eliminates need for manual cleanup queries
- Ensures referential integrity
- Prevents orphaned data

---

## Data Validation

### Application Layer (Enforced in Code)
- Post.content: Max 500 characters
- CreditTransaction.amount: Minimum 1 (for purchases)
- User.credits: Cannot go negative (checked before generation)

### Database Layer (Enforced by Schema)
- Unique constraints: clerkId, email
- Foreign key constraints: All relationships
- Default values: credits (10), platform (linkedin), status (draft)

---

## Clerk Webhook Integration

### User Synchronization
The database stays in sync with Clerk via webhooks:

**Webhook Endpoint**: `/api/webhooks/clerk`

**Handled Events**:
1. `user.created`
   - Creates User record in database
   - Initializes with 10 credits
   - Sets clerkId and email

2. `user.updated`
   - Updates email if changed
   - Maintains clerkId consistency

3. `user.deleted`
   - Deletes User record
   - Cascade deletes all Posts and Transactions

4. `organization.created`
   - Logs organization creation (placeholder)

5. `organizationMembership.created`
   - Logs membership changes (placeholder)

**Error Handling**:
- Duplicate user creation (P2002): Silently ignored
- Missing email: Returns 400 error
- Webhook verification failure: Returns 400 error

---

## Seed Data

### Test User
- **Email**: test@postforge.ai
- **ClerkId**: seed_test_user_clerk_id
- **Credits**: 10
- **OrganizationId**: null

### Test Posts
1. **Draft Post**
   - Content: "This is my first AI-generated LinkedIn post!..."
   - Status: draft
   - Platform: linkedin

2. **Published Post**
   - Content: "5 key lessons I learned from building an AI startup..."
   - Status: published
   - Platform: linkedin

### Test Transactions
1. Bonus: +10 credits (Welcome bonus)
2. Generation: -1 credit (First post)
3. Generation: -1 credit (Second post)

**Run Seed**: `npm run db:seed`

---

## Database Scripts

### Check Database State
```bash
npx tsx scripts/check-db.ts
```
Shows all users, posts, and transactions with counts.

### Test Relationships
```bash
npx tsx scripts/test-relationships.ts
```
Validates all relationships and cascade behaviors.

### Seed Database
```bash
npm run db:seed
```
Populates database with test data.

### Prisma Studio
```bash
npm run db:studio
```
Visual database browser at http://localhost:5555

---

## Future Enhancements

### Planned Features
1. **Organization Support**
   - Implement team workspaces
   - Shared credit pools
   - Member role management

2. **Post Scheduling**
   - Add scheduledFor timestamp
   - Implement background job queue
   - Add retry logic for failed posts

3. **Analytics Tracking**
   - Post engagement metrics
   - Credit usage analytics
   - User activity logs

4. **Credit Packages**
   - Stripe subscription integration
   - Credit package tiers
   - Automatic credit top-ups

### Performance Improvements
1. **Connection Pooling**
   - PgBouncer for connection management
   - Reduce connection overhead

2. **Read Replicas**
   - Separate read/write operations
   - Scale read-heavy queries

3. **Caching Layer**
   - Redis for frequent queries
   - Cache user credit balances
   - Cache recent posts

---

## Production Checklist

- [ ] Database backups configured
- [ ] Connection pooling enabled
- [ ] Read replicas set up (if needed)
- [ ] Database monitoring active
- [ ] Error tracking for webhooks
- [ ] Rate limiting for credit operations
- [ ] Database access logging
- [ ] Query performance monitoring
- [ ] Migration rollback strategy
- [ ] Disaster recovery plan

---

## Support Commands

### Validate Schema
```bash
npx prisma validate
```

### Generate Prisma Client
```bash
npm run prisma:generate
```

### Create Migration
```bash
npm run db:migrate
```

### Check Migration Status
```bash
npx prisma migrate status
```

### Reset Database (DEVELOPMENT ONLY)
```bash
npx prisma migrate reset
```

---

## Troubleshooting

### Connection Issues
1. Verify DATABASE_URL in .env
2. Check Supabase project status
3. Test connection: `npx prisma studio`

### Migration Errors
1. Check migration history: `npx prisma migrate status`
2. Review migration files in `prisma/migrations/`
3. Validate schema: `npx prisma validate`

### Webhook Failures
1. Check CLERK_WEBHOOK_SECRET in .env
2. Review Clerk Dashboard webhook logs
3. Check terminal logs for errors
4. Verify webhook endpoint accessibility

### Type Safety Issues
1. Regenerate client: `npm run prisma:generate`
2. Check TypeScript errors: `npx tsc --noEmit`
3. Restart TypeScript server in IDE

---

**Maintained by**: PostForge Development Team
**Last Review**: 2025-12-03
**Next Review**: After Step 4 completion
